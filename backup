#!/usr/bin/env python

from lib.database import Database
from lib.menu import Menu
from lib.inlretro import dump_game
from lib.inesheader import write_with_header
from os import close, path, remove
from tempfile import mkstemp

database = Database('vendor/xml/nesdb.xml')
menu = Menu()

game = None
while(game == None):
    input = raw_input("Search for game: ")
    suggestions = database.search(input)
    selection = menu.select_item(suggestions)
    if selection != None:
        game = database.get_game_for_search_string(selection)
        
print("Creating backup for %s, %s" % (game.name, game.catalog))

# This is a little bit awkward, because we need the INL Retro subprocess to write to
# the tempfile first. Also: not sure if this works in Windows, but probably neither
# does anything else in here.
bin_fd, bin_filename = mkstemp()
close(bin_fd)

dump_game(game, bin_filename)
write_with_header(game, bin_filename, "roms/%s (%s).nes" % (game.name, game.region))

# Temp file cleanup
remove(bin_filename)
